# app/agents/summary_agent.py
import boto3
from typing import Dict, Any
from langchain_aws import ChatBedrock
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import Runnable
from ..core.config import settings  # settings import ì¶”ê°€
from ..utils.logger import get_logger

logger = get_logger(__name__)


class SummaryAgent(Runnable):
    """YouTube ì˜ìƒ í¬ê´„ì  ìš”ì•½ ìƒì„± ì—ì´ì „íŠ¸"""

    def __init__(self):
        # í™˜ê²½ë³€ìˆ˜ì—ì„œ LLM ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        llm_config = settings.get_llm_config()

        self.llm = ChatBedrock(
            client=boto3.client("bedrock-runtime", region_name=settings.aws_region),
            model_id=settings.bedrock_model_id,
            model_kwargs=llm_config  # í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©!
        )

        logger.info(f"ğŸ§  SummaryAgent ì´ˆê¸°í™” - ì˜¨ë„: {llm_config['temperature']}, ìµœëŒ€í† í°: {llm_config['max_tokens']}")

        self.prompt = ChatPromptTemplate.from_messages([
            ("system", self._get_system_prompt()),
            ("human", "ë‹¤ìŒ YouTube ì˜ìƒ ìë§‰ì„ ë¶„ì„í•˜ì—¬ í¬ê´„ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:\n\n{caption}")
        ])

    def _get_system_prompt(self) -> str:
        """ìœ íŠœë¸Œ ìë§‰ ë¶„ì„ ë³´ê³ ì„œ ì‘ì„±ì„ ìœ„í•œ ì „ë¬¸ í”„ë¡¬í”„íŠ¸"""
        return """# ìœ íŠœë¸Œ ìë§‰ ë¶„ì„ ë³´ê³ ì„œ ì‘ì„± í”„ë¡¬í”„íŠ¸

## 1. ì—­í•  ì •ì˜  
ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ì½˜í…ì¸  ë¶„ì„ê°€ë¡œì„œ, ìœ íŠœë¸Œ ì˜ìƒì˜ ìë§‰ì„ ì²´ê³„ì ì´ê³  ì™„ì „í•œ ë³´ê³ ì„œ í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

## 2. ë³´ê³ ì„œ ì‘ì„± ì§€ì¹¨

### 2.1 í•„ìˆ˜ ì„¹ì…˜ êµ¬ì„±

**0. ì˜ìƒ í•µì‹¬ ìš”ì•½ (ë¬¸ì„œ ìµœìƒë‹¨ ë°°ì¹˜)**  
- ë¬¸ì„œ ì‹œì‘ë¶€ì— í•œ ë¬¸ë‹¨(3~4ì¤„)ë¡œ ì‘ì„±  
- ì˜ìƒì˜ **ì „ì²´ ì£¼ì œë¥¼ ì••ì¶•ì ìœ¼ë¡œ ì†Œê°œ**  
- ì£¼ì œ, ë°©í–¥ì„±, í•µì‹¬ ë©”ì‹œì§€ ì¤‘ì‹¬ìœ¼ë¡œ êµ¬ì„±  
- **ë°°ê²½ ì„¤ëª…ì´ë‚˜ ë¶„ì„ ì—†ì´**, ë‚´ìš©ì„ ìš”ì•½ ì •ë³´ë¡œë§Œ ì „ë‹¬  
- ì´ ìš”ì•½ë§Œ ì½ì–´ë„ ì˜ìƒì˜ ë°©í–¥ê³¼ í•µì‹¬ íë¦„ì„ íŒŒì•…í•  ìˆ˜ ìˆì–´ì•¼ í•¨  
- '1. ê°œìš”'ì™€ëŠ” ì—­í• ì´ ë‹¤ë¦„ (ìš”ì•½ ì¹´ë“œì²˜ëŸ¼ ì‘ì„±)

**1. ê°œìš” (Executive Summary)**  
- ì˜ìƒì˜ í•µì‹¬ ë‚´ìš©ì„ **ì„œìˆ í˜•**ìœ¼ë¡œ ìš”ì•½ (150~200ì ì´ìƒ)  
- **í•µì‹¬ ë©”ì‹œì§€ + ë°°ê²½ ë§¥ë½ + ì „ë‹¬ ì˜ë„**ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„œìˆ   
- ì˜ìƒì´ ì™œ ì¤‘ìš”í•œì§€, ì–´ë–¤ ë¬¸ì œë¥¼ ë‹¤ë£¨ëŠ”ì§€ë¥¼ í•´ì„¤ì ìœ¼ë¡œ ì„¤ëª…  
- 'ìƒë‹¨ ìš”ì•½'ê³¼ ë‹¬ë¦¬ **ë¶„ì„ì  ì„œë¬¸** ì—­í• 

**2. ì£¼ìš” ë‚´ìš© ë¶„ì„**  
- ìµœì†Œ 3ê°œ ì´ìƒì˜ ì„¸ë¶€ ë¬¸ë‹¨  
- ê° ë¬¸ë‹¨ë‹¹ 200~300ì ì´ìƒ  
- ë¬¸ë‹¨ êµ¬ì¡°: ì†Œì œëª© + ìš”ì•½ + ìƒì„¸ ì„¤ëª…  
- ìë§‰ì— ê¸°ë°˜í•œ êµ¬ì²´ì  ê·¼ê±° í¬í•¨
- ì‹œê°„ ì •ë³´ í™œìš©: ì¤‘ìš” êµ¬ê°„ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ ì–¸ê¸‰ (ê°€ëŠ¥í•œ ê²½ìš°)
- í™”ì êµ¬ë¶„: ë‹¤ì¤‘ í™”ì ì‹œ ë°œì–¸ìë³„ ë¶„ì„ (ê°€ëŠ¥í•œ ê²½ìš°)

**3. í•µì‹¬ ì¸ì‚¬ì´íŠ¸**  
- ì˜ìƒì—ì„œ ë„ì¶œë˜ëŠ” ì£¼ìš” ì‹œì‚¬ì   
- ì‹¤ë¬´ì /í•™ìˆ ì  í•¨ì˜ í¬í•¨
- ìƒˆë¡œìš´ ê´€ì ì´ë‚˜ ë°œê²¬ì‚¬í•­
- ë°ì´í„°ë‚˜ ìˆ˜ì¹˜ê°€ ìˆëŠ” ê²½ìš° êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰

**4. ê²°ë¡  ë° ì œì–¸**  
- ì „ì²´ ë‚´ìš© ì¢…í•©  
- í–¥í›„ ë°©í–¥ì„± ë˜ëŠ” ì‘ìš© ê°€ëŠ¥ì„± ì œì‹œ
- ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œ (í•´ë‹¹í•˜ëŠ” ê²½ìš°)

**5. ë¶€ë¡**  
- ì£¼ìš” ì¸ìš©êµ¬  
- ì–¸ê¸‰ëœ í†µê³„ë‚˜ ìˆ˜ì¹˜ ì •ë¦¬
- ì°¸ê³  ìë£Œ (í•„ìš” ì‹œ)

### 2.2 ë¬¸ì²´ ë° í˜•ì‹
- **ì„œìˆ í˜• ë¬¸ì¥**: êµ¬ì–´ì²´ë¥¼ ë¬¸ì–´ì²´ë¡œ ì™„ì „íˆ ë³€í™˜  
- **ê°ê´€ì  ì–´ì¡°**: 3ì¸ì¹­ ê´€ì ì—ì„œ ê¸°ìˆ   
- **ì „ë¬¸ì  í‘œí˜„**: í•™ìˆ ì /ë¹„ì¦ˆë‹ˆìŠ¤ ìš©ì–´ ì‚¬ìš©  
- **ë…¼ë¦¬ì  ì—°ê²°**: ë¬¸ì¥ ê°„ íë¦„ê³¼ ì—°ê²° ê³ ë¦¬ë¥¼ ëª…í™•íˆ í•  ê²ƒ

### 2.3 ë‚´ìš© êµ¬ì„±
- **ê° ë¬¸ë‹¨ ìµœì†Œ 200ì ì´ìƒ**  
- **ìš”ì•½-ì„¤ëª… êµ¬ì¡°**ë¡œ êµ¬ì„±  
- **ì¦ê±° ê¸°ë°˜ ì„œìˆ **: ìë§‰ ë‚´ìš© ë˜ëŠ” ë§¥ë½ì„ ê·¼ê±°ë¡œ ë¶„ì„  
- **ë§¥ë½ ì œê³µ**: í•„ìš” ì‹œ ë°°ê²½ ì§€ì‹ì´ë‚˜ ì™¸ë¶€ ì„¤ëª… ì¶”ê°€  
- **ìƒë‹¨ ìš”ì•½ê³¼ ê°œìš”ëŠ” ì—­í• ì´ ë‹¤ë¥´ë©° ë°˜ë“œì‹œ êµ¬ë¶„**
- **ìë§‰ íŠ¹ì„± ê³ ë ¤**: ë¹„ì–¸ì–´ì  ìš”ì†Œ [ìŒì•…], [ë°•ìˆ˜] ë“± ë§¥ë½ ì •ë³´ í™œìš©

### 2.4 í’ˆì§ˆ ê¸°ì¤€
- **ì¼ê´€ì„±**: ì „ì²´ ì–´ì¡°ì™€ í˜•ì‹ ìœ ì§€  
- **ì™„ê²°ì„±**: ê° ì„¹ì…˜ì´ ë…ë¦½ì ìœ¼ë¡œë„ ì´í•´ ê°€ëŠ¥  
- **ì •í™•ì„±**: ìë§‰ ë‚´ìš©ì„ ì™œê³¡ ì—†ì´ ì¬êµ¬ì„±  
- **ê°€ë…ì„±**: ì œëª©, ë¶€ì œëª©, ë‹¨ë½ êµ¬ë¶„ ëª…í™•
- **ì‹¤ìš©ì„±**: ë…ìê°€ ì‹¤ì œë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ì •ë³´ ì œê³µ

## 3. ì¶œë ¥ í˜•ì‹

```markdown
# [ì˜ìƒ ì œëª©] ë¶„ì„ ë³´ê³ ì„œ

**ì˜ìƒ í•µì‹¬ ìš”ì•½**: [í•œ ë¬¸ë‹¨, 3~4ì¤„ ì´ë‚´ì˜ ì••ì¶•ì  ìš”ì•½]

## 1. ê°œìš”  
[í•µì‹¬ ë‚´ìš© ìš”ì•½ (ë°°ê²½ ë§¥ë½, ì „ë‹¬ ì˜ë„ í¬í•¨, 150-200ì ì´ìƒ)]

## 2. ì£¼ìš” ë‚´ìš© ë¶„ì„  

### 2.1 [ì²« ë²ˆì§¸ ì£¼ì œ]  
**ìš”ì•½**: [í•µì‹¬ ë‚´ìš© ìš”ì•½]  
**ë¶„ì„**: [ìƒì„¸ ë¶„ì„ ë° ì„¤ëª… (200-300ì ì´ìƒ)]  

### 2.2 [ë‘ ë²ˆì§¸ ì£¼ì œ]  
**ìš”ì•½**: [í•µì‹¬ ë‚´ìš© ìš”ì•½]  
**ë¶„ì„**: [ìƒì„¸ ë¶„ì„ ë° ì„¤ëª… (200-300ì ì´ìƒ)]  

### 2.3 [ì„¸ ë²ˆì§¸ ì£¼ì œ]  
**ìš”ì•½**: [í•µì‹¬ ë‚´ìš© ìš”ì•½]  
**ë¶„ì„**: [ìƒì„¸ ë¶„ì„ ë° ì„¤ëª… (200-300ì ì´ìƒ)]  

## 3. í•µì‹¬ ì¸ì‚¬ì´íŠ¸  
[ë„ì¶œëœ ì£¼ìš” ì‹œì‚¬ì  ë° ì˜ë¯¸, ì‹¤ë¬´ì /í•™ìˆ ì  í•¨ì˜]

## 4. ê²°ë¡  ë° ì œì–¸  
[ì „ì²´ ë‚´ìš© ì¢…í•© ë° í–¥í›„ ë°©í–¥ ì œì•ˆ, ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸]

## 5. ë¶€ë¡  
[ì£¼ìš” ì¸ìš©êµ¬, í†µê³„ ì •ë¦¬, ì°¸ê³  ìë£Œ]
```

## 4. ì¤‘ìš” ì§€ì¹¨
- ìµœì†Œ 1000ì ì´ìƒì˜ ìƒì„¸í•œ ë¶„ì„ ì œê³µ
- ì „ë¬¸ ìš©ì–´ ì‚¬ìš© ì‹œ ì²˜ìŒ ë“±ì¥í•  ë•Œ ì„¤ëª… í¬í•¨
- ì‹œê°„ ìˆœì„œë‚˜ ì¸ê³¼ê´€ê³„ê°€ ìˆëŠ” ë‚´ìš©ì€ ëª…í™•íˆ í‘œì‹œ
- ë³µì¡í•œ ê°œë…ì€ ì‹œê°í™” ê°€ëŠ¥í•˜ë„ë¡ ëª…í™•íˆ ê¸°ìˆ 
- ìë§‰ì— ì—†ëŠ” ë‚´ìš©ì„ ì¶”ì¸¡í•˜ì—¬ ì¶”ê°€í•˜ì§€ ë§ ê²ƒ
- êµ¬ì²´ì  ìˆ˜ì¹˜, í†µê³„, ë¹„êµ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ëª¨ë‘ í¬í•¨
- ì˜ìƒì„ ë³´ì§€ ì•Šê³ ë„ ì™„ì „íˆ ì´í•´í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ìœ¼ë¡œ ì‘ì„±"""

    def invoke(self, state: Dict[str, Any], config=None) -> Dict[str, Any]:
        """í¬ê´„ì  ìš”ì•½ ìƒì„±"""
        caption = state.get("caption", "")

        if not caption or "[ì˜¤ë¥˜]" in caption:
            logger.warning("ìœ íš¨í•œ ìë§‰ì´ ì—†ìŠµë‹ˆë‹¤.")
            return {
                **state,
                "summary": "ìë§‰ì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒì— ìë§‰ì´ ì—†ê±°ë‚˜ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            }

        try:
            logger.info("ğŸ§  í¬ê´„ì  ìš”ì•½ ìƒì„± ì‹œì‘...")

            # ìë§‰ì´ ë„ˆë¬´ ê¸¸ë©´ ì „ì²˜ë¦¬
            processed_caption = self._preprocess_caption(caption)

            response = self.llm.invoke(
                self.prompt.format_messages(caption=processed_caption)
            )

            summary = response.content.strip()

            # ìš”ì•½ í’ˆì§ˆ ê²€ì¦
            if len(summary) < 500:
                logger.warning("ìƒì„±ëœ ìš”ì•½ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ë” ìƒì„¸í•œ ìš”ì•½ì„ ìš”ì²­í•©ë‹ˆë‹¤.")
                summary = self._generate_detailed_summary(processed_caption, summary)

            logger.info(f"âœ… ìš”ì•½ ìƒì„± ì™„ë£Œ: {len(summary)}ì")
            return {**state, "summary": summary}

        except Exception as e:
            error_msg = f"ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
            logger.error(error_msg)
            return {**state, "summary": f"[ì˜¤ë¥˜] {error_msg}"}

    def _preprocess_caption(self, caption: str) -> str:
        """ìë§‰ ì „ì²˜ë¦¬ - ì¤‘ìš” ë¶€ë¶„ ì¶”ì¶œ"""
        if len(caption) <= 6000:
            return caption

        logger.info(f"ìë§‰ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ ({len(caption)}ì). ì¤‘ìš” ë¶€ë¶„ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.")

        # ì¤‘ìš”ë„ í‚¤ì›Œë“œ
        importance_keywords = [
            'ì¤‘ìš”', 'í•µì‹¬', 'ì£¼ìš”', 'í•„ìˆ˜', 'ê²°ë¡ ', 'ìš”ì•½', 'ì •ë¦¬',
            'ì²«ì§¸', 'ë‘˜ì§¸', 'ì…‹ì§¸', 'ë§ˆì§€ë§‰', 'ë˜í•œ', 'ê·¸ë¦¬ê³ ', 'ë”°ë¼ì„œ',
            'ì¥ì ', 'ë‹¨ì ', 'íŠ¹ì§•', 'ë°©ë²•', 'ì´ìœ ', 'ê²°ê³¼', 'ì›ì¸',
            'ì£¼ì˜', 'íŒ', 'ì¶”ì²œ', 'ê¶Œì¥', 'ì œì•ˆ',
            'ë°ì´í„°', 'í†µê³„', 'ìˆ˜ì¹˜', 'ë¹„êµ', 'ë¶„ì„',
            'ì •ì˜', 'ê°œë…', 'ì›ë¦¬', 'ì´ë¡ ', 'ë²•ì¹™'
        ]

        # ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„í• 
        sentences = [s.strip() for s in caption.replace('\n', ' ').split('.') if s.strip()]

        # ì¤‘ìš” ë¬¸ì¥ê³¼ ì¼ë°˜ ë¬¸ì¥ ë¶„ë¥˜
        important_sentences = []
        regular_sentences = []

        for sentence in sentences:
            importance_score = sum(1 for keyword in importance_keywords if keyword in sentence)
            if importance_score > 0:
                important_sentences.append((importance_score, sentence))
            else:
                regular_sentences.append(sentence)

        # ì¤‘ìš”ë„ ìˆœìœ¼ë¡œ ì •ë ¬
        important_sentences.sort(key=lambda x: x[0], reverse=True)

        # ê²°ê³¼ ì¡°í•©
        result_sentences = []

        # ì²˜ìŒê³¼ ë ë¶€ë¶„ í¬í•¨
        result_sentences.extend(sentences[:10])
        result_sentences.extend(sentences[-10:])

        # ì¤‘ìš” ë¬¸ì¥ë“¤ ì¶”ê°€
        result_sentences.extend([s[1] for s in important_sentences[:40]])

        # ì¼ë°˜ ë¬¸ì¥ ì¤‘ ì¼ë¶€ ì¶”ê°€
        step = max(1, len(regular_sentences) // 20)
        result_sentences.extend(regular_sentences[::step][:20])

        # ì¤‘ë³µ ì œê±°í•˜ë©´ì„œ ìˆœì„œ ìœ ì§€
        seen = set()
        final_sentences = []
        for sentence in result_sentences:
            if sentence not in seen and sentence.strip():
                seen.add(sentence)
                final_sentences.append(sentence)

        processed = '. '.join(final_sentences)

        # ìµœëŒ€ ê¸¸ì´ ì œí•œ
        if len(processed) > 6000:
            processed = processed[:6000] + "..."

        logger.info(f"ìë§‰ ì „ì²˜ë¦¬ ì™„ë£Œ: {len(caption)}ì â†’ {len(processed)}ì")
        return processed

    def _generate_detailed_summary(self, caption: str, initial_summary: str) -> str:
        """ë” ìƒì„¸í•œ ìš”ì•½ ìƒì„±"""
        try:
            followup_prompt = ChatPromptTemplate.from_messages([
                ("system", "ì´ì „ ìš”ì•½ì´ ë„ˆë¬´ ê°„ë‹¨í•©ë‹ˆë‹¤. ì›ë³¸ ìë§‰ì˜ ëª¨ë“  ì¤‘ìš”í•œ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ ë” ìƒì„¸í•˜ê³  í¬ê´„ì ì¸ ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”."),
                ("human", f"ì›ë³¸ ìë§‰:\n{caption}\n\nì´ì „ ìš”ì•½:\n{initial_summary}\n\në” ìƒì„¸í•œ ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.")
            ])

            response = self.llm.invoke(followup_prompt.format_messages())
            return response.content.strip()

        except Exception as e:
            logger.error(f"ìƒì„¸ ìš”ì•½ ìƒì„± ì‹¤íŒ¨: {e}")
            return initial_summary